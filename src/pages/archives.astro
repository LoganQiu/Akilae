---
import { getCollection } from 'astro:content';
import ListLayout from '../layouts/ListLayout.astro';
import BlogCard from '../components/BlogCard.astro';

const blogPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = blogPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsByYear = new Map<number, typeof blogPosts>();
sortedPosts.forEach(post => {
  const year = post.data.date.getFullYear();
  if (!postsByYear.has(year)) {
    postsByYear.set(year, []);
  }
  postsByYear.get(year)!.push(post);
});

const sortedYears = Array.from(postsByYear.keys()).sort((a, b) => b - a);
---

<ListLayout title="Archives">
  <h1>Archives</h1>

  <div class="main archive">
    {sortedYears.map(year => (
      <>
        <h2>{year}</h2>
        {postsByYear.get(year)!.map(post => (
          <BlogCard post={post} />
        ))}
      </>
    ))}
  </div>
</ListLayout>
